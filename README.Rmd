---
output: github_document
---

## <u>`flairR`</u>: An R Wrapper for Accessing Flair NLP Library <img src="man/figures/logo.png" align="right" width="180"/>

[![R-MacOS](https://github.com/davidycliao/flaiR/actions/workflows/r_macos.yml/badge.svg)](https://github.com/davidycliao/flaiR/actions/workflows/r_macos.yml)
[![R-ubuntu](https://github.com/davidycliao/flaiR/actions/workflows/r_ubuntu.yaml/badge.svg)](https://github.com/davidycliao/flaiR/actions/workflows/r_ubuntu.yaml)
[![R-Windows](https://github.com/davidycliao/flaiR/actions/workflows/r_window.yml/badge.svg)](https://github.com/davidycliao/flaiR/actions/workflows/r_window.yml)

[![R-CMD-Check](https://github.com/davidycliao/flaiR/actions/workflows/r.yml/badge.svg)](https://github.com/davidycliao/flaiR/actions/workflows/r.yml)
[![coverage](https://github.com/davidycliao/flaiR/actions/workflows/test-coverage.yaml/badge.svg)](https://github.com/davidycliao/flaiR/actions/workflows/test-coverage.yaml)
[![codecov](https://codecov.io/gh/davidycliao/flaiR/graph/badge.svg?token=CPIBIB6L78)](https://codecov.io/gh/davidycliao/flaiR)
[![CodeFactor](https://www.codefactor.io/repository/github/davidycliao/flair/badge)](https://www.codefactor.io/repository/github/davidycliao/flair)

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

```{r include=FALSE}
library(reticulate)
library(flaiR)
reticulate::py_install("flair")
system(paste(reticulate::py_config()$python, "-m pip install flair"))
# options(repos = c(CRAN = "https://cloud.r-project.org/"))
install.packages("remotes")
```

<div style="text-align: justify">

__flaiR__ is an R wrapper for accessing the [flairNLP/flair](flairNLP/flair) Python library, specifically designed for R users in social and political science. flaiR provides convenient access to the main functionalities of flairNLP for training word embedding-based deep learning models and fine-tune state-of-the-art transformers hosted on Hugging Face. This is the third-party package in R maintained by [David Liao](https://davidycliao.github.io), [Stefan Müller](https://muellerstefan.net) from [Next Generation Energy Systems](https://www.nexsys-energy.ie)  and friends at [Text and Policy Research Group](https://text-and-policy.com) and [Connected_Politics Lab](https://www.ucd.ie/connected_politics/) in UCD. 


## Installation via  <u>__`GitHub`__</u>

<div style="text-align: justify">

__flaiR__ runs the Flair NLP backend in Python, thus requiring Python installation. We have extensively tested flaiR using CI/CD with GitHub Actions, conducting integration tests across various operating systems. These tests includes integration between R versions 4.2.1, 4.3.2, and 4.2.0, along with Python 3.9 and 3.10.x. Additionally, the testing includes environments with PyTorch, Flair NLP, and their dependencies in both R and Python. For stable usage, we strongly recommend installing these specific versions.

| OS      | R Versions                 | Python Version |
|---------|----------------------------|----------------|
| Mac     | 4.3.2, 4.2.0, 4.2.1        | 3.10.x         |
| Mac     | Latest                     | 3.9            |
| Windows | 4.0.5                      | 3.10.x         |
| Windows | Latest                     | 3.9            |
| Ubuntu  | 4.3.2, 4.2.0, 4.2.1        | 3.10.x         |
| Ubuntu  | Latest                     | 3.9            |


_[Anaconda](https://github.com/anaconda) or [miniconda](https://github.com/conda/conda) (highly recommended) is the best way to manage your working environment. In RStudio, the Python (conda) environment can easily be managed by the reticulate R package, or manually changed configuration via Tools -> Global Options -> Python in Rstudio._


## Tutorial for Finetune Transformers with FlaiR

<div style="text-align: justify">

We use Stefan's data from \textit{The Temporal Focus of Campaign Communication (JOP 2022)} as an example. Let's assume we receive the data for training from different times. First, suppose you have a dataset of 1000 entries called \texttt{cc\_muller\_old}. Additionally, we have another 1000 entries in a dataset called \texttt{cc\_muller\_new}. Both subsets are from \texttt{data(cc\_muller)}. We will show how to fine-tune a transformer model with \texttt{cc\_muller\_old}, and then continue with another round of fine-tuning using \texttt{cc\_muller\_new}.


```{r}
library(flaiR)
```

### Fine-tuning a New Model

<u>__Step 1__</u> Load Necessary Modules from Flair

Load necessary classes from `flair` package.
```{r}
# Sentence is a class for holding a text sentence
Sentence <- flair_data()$Sentence

# Corpus is a class for text corpora
Corpus <- flair_data()$Corpus

# TransformerDocumentEmbeddings is a class for loading transformer 
TransformerDocumentEmbeddings <- flair_embeddings()$TransformerDocumentEmbeddings

# TextClassifier is a class for text classification
TextClassifier <- flair_models()$TextClassifier

# ModelTrainer is a class for training and evaluating models
ModelTrainer <- flair_trainers()$ModelTrainer
```

We use purrr to help us split sentences using Sentence from `flair_data()`, then use map2 to add labels, and finally use `Corpus` to segment the data.

```{r}
library(purrr)

data(cc_muller)
cc_muller_old <- cc_muller[1:1000,]

old_text <- map(cc_muller_old$text, Sentence)
old_labels <- as.character(cc_muller_old$class)

old_text <- map2(old_text, old_labels, ~ {
   
  .x$add_label("classification", .y)
  .x
})
```

```{r}
print(length(old_text))
```

```{r}
set.seed(2046)
sample <- sample(c(TRUE, FALSE), length(old_text), replace=TRUE, prob=c(0.8, 0.2))
old_train  <- old_text[sample]
old_test   <- old_text[!sample]

test_id <- sample(c(TRUE, FALSE), length(old_test), replace=TRUE, prob=c(0.5, 0.5))
old_test   <- old_test[test_id]
old_dev   <- old_test[!test_id]
```

If you do not provide a development split (dev split) while using Flair, it will automatically split the training data into training and development datasets. The test set is used for training the model and evaluating its final performance, whereas the development set (dev set) is used for adjusting model parameters and preventing overfitting, or in other words, for early stopping of the model.

```{r}
old_corpus <- Corpus(train = old_train, test = old_test)
```

<u>__Step 3__</u> Load `distilbert` Transformer  

```{r}
document_embeddings <- TransformerDocumentEmbeddings('distilbert-base-uncased', fine_tune=TRUE)
```

First, `$make_label_dictionary` function is used to automatically create a label dictionary for the classification task. The label dictionary is a mapping from label to index, which is used to map the labels to a tensor of label indices. expcept classifcation task, flair also supports other label types for training custom model, such as `ner`, `pos` and `sentiment`. From the cc_muller dataset: Future (seen 423 times), Present (seen 262 times), Past (seen 131 times)

```{r}
old_label_dict <- old_corpus$make_label_dictionary(label_type="classification")
```

`TextClassifier` is used to create a text classifier. The classifier takes the document embeddings (importing from `'distilbert-base-uncased'` from HugginFace)  and the label dictionary as input. The label type is also specified as classification.

```{r}
old_classifier <- TextClassifier(document_embeddings,
                                 label_dictionary = old_label_dict, 
                                 label_type='classification')
```

<u>__Step 4__</u> Start Training 

`ModelTrainer` is used to train the model.

```{r eval=TRUE}
old_trainer <- ModelTrainer(model = old_classifier, corpus = old_corpus)
```

```{r eval=TRUE}
old_trainer$train("muller-campaign-communication",  
                  learning_rate=0.02,              
                  mini_batch_size=8L,              
                  anneal_with_restarts = TRUE,
                  save_final_model=TRUE,
                  max_epochs=1L)   
```



### Continue Fine-tuning `muller-campaign-communication` Model with `Additional 2000 Pieces`

Now, we can continue to fine-tune the already fine-tuned model with an additional 2000 pieces of data. First, let's say we have another 2000 entries called cc_muller_new. We can fine-tune the previous model with these 2000 entries. The steps are the same as before. For this case, we don't need to split the dataset again. We can use the entire 2000 entries as the training set and use the old_test set to evaluate how well our refined model performs.

```{r} 
library(purrr)
cc_muller_new <- cc_muller[1001:3000,]
new_text <- map(cc_muller_new$text, Sentence)
new_labels <- as.character(cc_muller_new$class)

new_text <- map2(new_text, new_labels, ~ {
  .x$add_label("classification", .y)
  .x
})
```


```{r}
new_corpus <- Corpus(train=new_text, test=old_test)
```

Load the model (`old_model`) we have already finetuned from previous stage and let's fine-tune it with the new data, `new_corpus`. 

```{r}
old_model <- TextClassifier$load("muller-campaign-communication/best-model.pt")
new_trainer <- ModelTrainer(old_model, new_corpus)
```

```{r eval=TRUE}
new_trainer$train("new-muller-campaign-communication",
                  learning_rate=0.002, 
                  mini_batch_size=8L,  
                  max_epochs=1L)    
```


More R tutorial and documentation see [here](https://github.com/davidycliao/flaiR).

</div>





<br>



<br>


## Contribution and Open Source


<div style="text-align: justify">

R developers who want to contribute to `flaiR` are welcome – flaiR is an open source project. I warmly invite R users who share similar interests to join in contributing to this package. Please feel free to shoot me an email to collaborate on the task. Contributions – whether they be comments, code suggestions, tutorial examples, or forking the repository – are greatly appreciated. Please note that the `flaiR` is released with the [Contributor Code of Conduct](https://github.com/davidycliao/flaiR/blob/master/CONDUCT.md). By contributing to this project, you agree to abide by its terms. 

The primary communication channel for R users can be found [here](https://github.com/davidycliao/flaiR/discussions). Please feel free to share your insights on the [Discussion](https://github.com/davidycliao/flaiR/discussions) page and report any issues related to the R interface in the [Issue](https://github.com/davidycliao/flaiR/issues) section. If the issue pertains to the actual implementation of Flair in Python, please submit a pull request to the offical [flair NLP](https://github.com/flairnlp/flair). 


</div>

<br>





